{% extends "base.html" %}
{% block content %}
  <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
    <div>
      <h2>{{ asset_title }}</h2>
      <p class="muted">Asset detail, assignment history, and comments.</p>
    </div>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <a class="button secondary" href="{{ url_for('edit_asset', asset_type=asset_type, item_id=item.id) }}">Edit</a>
      <a class="button" href="{{ url_for('list_assets', asset_type=asset_type) }}">Back</a>
    </div>
  </div>

  <div class="card" style="margin-top: 16px;">
    <h3 style="margin-top: 0;">Asset Overview</h3>
    <table>
      <thead>
        <tr>
          <th>Field</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        {% for field_name, label, field_type, value in fields %}
          <tr>
            <td>{{ label }}</td>
            <td>{{ value if value not in [None, ""] else "-" }}</td>
          </tr>
        {% endfor %}
        <tr>
          <td>User</td>
          <td>{{ assigned_to }}</td>
        </tr>
      </tbody>
    </table>
    {% if previous_users %}
      <p class="muted" style="margin-top: 10px;">Previous users (latest 2): {{ previous_users | join(", ") }}</p>
    {% endif %}
  </div>

  <div class="card" style="margin-top: 16px;">
    <h3 style="margin-top: 0;">Assignment History</h3>
    {% if history %}
      <table>
        <thead>
          <tr>
            <th>When</th>
            <th>Assigned By</th>
            <th>From</th>
            <th>To</th>
          </tr>
        </thead>
        <tbody>
          {% for entry in history %}
            <tr>
              <td>{{ entry.created_at.strftime("%Y-%m-%d %H:%M:%S") }}</td>
              <td>{{ entry.assigned_by or "-" }}</td>
              <td>{{ display_assignee(entry.from_user) }}</td>
              <td>{{ display_assignee(entry.to_user) }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="muted">No assignment history yet.</p>
    {% endif %}
  </div>

  <div class="card" style="margin-top: 16px;">
    <h3 style="margin-top: 0;">Comments</h3>
    <form method="post" action="{{ url_for('add_asset_comment', asset_type=asset_type, item_id=item.id) }}" style="display: grid; gap: 10px;">
      <textarea name="comment" rows="3" placeholder="Add a comment..." required></textarea>
      <button class="button" type="submit">Add Comment</button>
    </form>
    {% if comments %}
      <div style="margin-top: 14px; display: grid; gap: 10px;">
        {% for comment in comments %}
          <div class="card" style="margin: 0; padding: 12px 14px;">
            <div style="display: flex; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
              <strong>{{ comment.username or "System" }}</strong>
              <span class="muted">{{ comment.created_at.strftime("%Y-%m-%d %H:%M:%S") }}</span>
            </div>
            <p style="margin-bottom: 0;">{{ comment.body }}</p>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted" style="margin-top: 12px;">No comments yet.</p>
    {% endif %}
  </div>
{% endblock %}
