{% extends "base.html" %}
{% block content %}
  <div class="card" style="max-width: 600px;">
    <h2>Edit {{ asset_type.label }}</h2>
    <form method="post" class="form-grid">
      {% for field in fields %}
        <div>
          <label for="{{ field.name }}">{{ field.label }}</label>
          {% if field.field_type == "checkbox" %}
            {% if field.options %}
              {% set selected = item.data.get(field.name, []) %}
              <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                {% for opt in field.options %}
                  <label style="display: flex; align-items: center; gap: 6px;">
                    <input type="checkbox" name="{{ field.name }}" value="{{ opt }}" {% if opt in selected %}checked{% endif %}>
                    <span>{{ opt }}</span>
                  </label>
                {% endfor %}
              </div>
            {% else %}
              <div class="checkbox-row">
                <input id="{{ field.name }}" name="{{ field.name }}" type="checkbox" {% if item.data.get(field.name) %}checked{% endif %}>
                <span class="muted">Toggle to set</span>
              </div>
            {% endif %}
            {% else %}
              {% if field.name == "dept" and dept_options %}
                <select id="{{ field.name }}" name="{{ field.name }}" {% if field.name != "assigned_to" %}required{% endif %}>
                  <option value="">-</option>
                  {% if item.data.get(field.name) and item.data.get(field.name) not in dept_options %}
                    <option value="{{ item.data.get(field.name) }}" selected>{{ item.data.get(field.name) }}</option>
                  {% endif %}
                  {% for option in dept_options %}
                    <option value="{{ option }}" {% if item.data.get(field.name) == option %}selected{% endif %}>{{ option }}</option>
                  {% endfor %}
                </select>
              {% else %}
                <input id="{{ field.name }}" name="{{ field.name }}" type="text" value="{{ item.data.get(field.name, '') }}" {% if field.name in assigned_fields %}list="ldap-users"{% endif %} {% if field.name != "assigned_to" %}required{% endif %}>
              {% endif %}
            {% endif %}
        </div>
      {% endfor %}
      <button class="button" type="submit">Save</button>
      <a class="button secondary" href="{{ url_for('list_custom_assets', asset_key=asset_type.key) }}">Cancel</a>
    </form>
  </div>
  <script>
    (() => {
      const statusEl = document.getElementById('status');
      const deptEl = document.getElementById('dept');
      if (!statusEl || !deptEl) return;
      const normalize = (value) => (value || '').toString().toLowerCase().replace('_', ' ').trim();
      const toggle = () => {
        const status = normalize(statusEl.value);
        const disableDept = status === 'broken' || status === 'write off' || status === 'in stock';
        deptEl.disabled = disableDept;
        deptEl.required = !disableDept;
        if (disableDept) {
          deptEl.value = '';
        }
      };
      statusEl.addEventListener('change', toggle);
      toggle();
    })();
  </script>
{% endblock %}
